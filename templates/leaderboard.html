<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Leaderboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .filters {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .filter-group {
            display: inline-block;
            margin-right: 30px;
            margin-bottom: 15px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .filter-group select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            min-width: 200px;
            max-width: 400px;
            width: auto;
        }
        
        .filter-group select option {
            padding: 5px 10px;
            white-space: normal;
            word-wrap: break-word;
            max-width: 400px;
        }
        
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .prompt-display {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .prompt-display h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .prompt-display pre {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
            margin: 0;
        }
        
        .leaderboard {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f8f9fa;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #f1f3f5;
        }
        
        tbody tr {
            transition: background-color 0.2s;
            cursor: pointer;
        }
        
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .rank {
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .rank-1 { color: #FFD700; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }
        
        .model-name {
            font-weight: 500;
        }
        
        .rmse {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        
        .n-runs {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .scale-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            background: #e3f2fd;
            color: #1976d2;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        
        .no-data {
            text-align: center;
            padding: 50px;
            color: #6c757d;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÜ Model Performance Leaderboard</h1>
        
        <div class="filters">
            <div class="filter-group">
                <label>Temperature</label>
                <select id="temperature" onchange="loadLeaderboard()">
                    <option value="">All</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Top-p</label>
                <select id="top_p" onchange="loadLeaderboard()">
                    <option value="">All</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>System Prompt</label>
                <select id="system_prompt_id" title="Select a specific system prompt to filter by" onchange="displayPromptContent(); loadLeaderboard()">
                    <option value="">All System Prompts</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Message Prompt</label>
                <select id="message_prompt_id" title="Select a specific message prompt to filter by" onchange="displayPromptContent(); loadLeaderboard()">
                    <option value="">All Message Prompts</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Min Runs</label>
                <select id="min_runs" onchange="loadLeaderboard()">
                    <option value="0">All</option>
                    <option value="1">1+</option>
                    <option value="5">5+</option>
                    <option value="10" selected>10+</option>
                    <option value="25">25+</option>
                    <option value="50">50+</option>
                </select>
            </div>
        </div>
        
        <!-- Prompt content display area -->
        <div id="prompt-display" class="prompt-display" style="display: none;">
            <div id="system-prompt-section" style="display: none;">
                <h3>Selected System Prompt:</h3>
                <pre id="system-prompt-content"></pre>
            </div>
            <div id="message-prompt-section" style="display: none; margin-top: 20px;">
                <h3>Selected Message Prompt:</h3>
                <pre id="message-prompt-content"></pre>
            </div>
        </div>
        
        <div class="leaderboard">
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Model</th>
                        <th>Scale</th>
                        <th>RMSE ‚Üì</th>
                        <th>N Runs</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <tr>
                        <td colspan="5" class="loading">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // Load available parameters
        async function loadParameters() {
            try {
                const response = await fetch('/api/parameters');
                const data = await response.json();
                
                // Populate temperature dropdown
                const tempSelect = document.getElementById('temperature');
                data.temperatures.forEach(temp => {
                    const option = document.createElement('option');
                    option.value = temp;
                    option.textContent = temp;
                    if (temp === 0.0) option.selected = true; // Set 0 as default
                    tempSelect.appendChild(option);
                });
                
                // Populate top-p dropdown
                const topPSelect = document.getElementById('top_p');
                data.top_ps.forEach(top_p => {
                    const option = document.createElement('option');
                    option.value = top_p;
                    option.textContent = top_p;
                    if (top_p === 1.0) option.selected = true; // Set 1.0 as default
                    topPSelect.appendChild(option);
                });
                
                // Populate prompt dropdowns and store full content
                const messagePromptSelect = document.getElementById('message_prompt_id');
                const systemPromptSelect = document.getElementById('system_prompt_id');
                
                // Add None options if there are results with null prompt values
                if (data.has_null_system_prompts) {
                    const noneOption = document.createElement('option');
                    noneOption.value = 'none';
                    noneOption.textContent = 'None';
                    systemPromptSelect.appendChild(noneOption);
                }
                
                if (data.has_null_message_prompts) {
                    const noneOption = document.createElement('option');
                    noneOption.value = 'none';
                    noneOption.textContent = 'None';
                    messagePromptSelect.appendChild(noneOption);
                }
                
                // Store prompts data globally for content display
                window.messagePromptsData = {};
                window.systemPromptsData = {};
                
                data.prompts.forEach(prompt => {
                    const option = document.createElement('option');
                    option.value = prompt.id;
                    option.textContent = prompt.name;
                    option.title = prompt.content_preview; // Show preview on hover
                    
                    if (prompt.type === 'message') {
                        messagePromptSelect.appendChild(option.cloneNode(true));
                        window.messagePromptsData[prompt.id] = prompt.full_content || prompt.content_preview;
                    } else if (prompt.type === 'system') {
                        systemPromptSelect.appendChild(option.cloneNode(true));
                        window.systemPromptsData[prompt.id] = prompt.full_content || prompt.content_preview;
                    }
                });
            } catch (error) {
                console.error('Error loading parameters:', error);
            }
        }
        
        // Display prompt content when selected
        function displayPromptContent() {
            const messagePromptId = document.getElementById('message_prompt_id').value;
            const systemPromptId = document.getElementById('system_prompt_id').value;
            
            const displayArea = document.getElementById('prompt-display');
            const messageSection = document.getElementById('message-prompt-section');
            const systemSection = document.getElementById('system-prompt-section');
            const messageContent = document.getElementById('message-prompt-content');
            const systemContent = document.getElementById('system-prompt-content');
            
            let showDisplay = false;
            
            // Handle message prompt
            if (messagePromptId && window.messagePromptsData && window.messagePromptsData[messagePromptId]) {
                messageContent.textContent = window.messagePromptsData[messagePromptId];
                messageSection.style.display = 'block';
                showDisplay = true;
            } else {
                messageSection.style.display = 'none';
            }
            
            // Handle system prompt
            if (systemPromptId && window.systemPromptsData && window.systemPromptsData[systemPromptId]) {
                systemContent.textContent = window.systemPromptsData[systemPromptId];
                systemSection.style.display = 'block';
                showDisplay = true;
            } else {
                systemSection.style.display = 'none';
            }
            
            displayArea.style.display = showDisplay ? 'block' : 'none';
        }
        
        // Load leaderboard data
        async function loadLeaderboard() {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '<tr><td colspan="5" class="loading">Loading...</td></tr>';
            
            // Build query parameters
            const params = new URLSearchParams();
            
            const temperature = document.getElementById('temperature').value;
            if (temperature) params.append('temperature', temperature);
            
            const top_p = document.getElementById('top_p').value;
            if (top_p) params.append('top_p', top_p);
            
            const message_prompt_id = document.getElementById('message_prompt_id').value;
            if (message_prompt_id) {
                if (message_prompt_id === 'none') {
                    params.append('message_prompt_id', 'null');
                } else {
                    params.append('message_prompt_id', message_prompt_id);
                }
            }
            
            const system_prompt_id = document.getElementById('system_prompt_id').value;
            if (system_prompt_id) {
                if (system_prompt_id === 'none') {
                    params.append('system_prompt_id', 'null');
                } else {
                    params.append('system_prompt_id', system_prompt_id);
                }
            }
            
            const min_runs = document.getElementById('min_runs').value;
            params.append('min_runs', min_runs);
            
            try {
                const response = await fetch(`/api/leaderboard?${params}`);
                const data = await response.json();
                
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="no-data">No results match the selected filters</td></tr>';
                    return;
                }
                
                tbody.innerHTML = '';
                
                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.style.backgroundColor = item.color + '20';  // Add transparency
                    row.onclick = () => window.location.href = `/scale/${item.scale_id}`;
                    
                    const rankClass = item.rank <= 3 ? `rank-${item.rank}` : '';
                    
                    row.innerHTML = `
                        <td class="rank ${rankClass}">#${item.rank}</td>
                        <td class="model-name" style="border-left: 4px solid ${item.color}; padding-left: 12px;">
                            ${item.model}
                        </td>
                        <td><span class="scale-badge">${item.scale}</span></td>
                        <td class="rmse">${item.rmse.toFixed(3)}</td>
                        <td class="n-runs">${item.n_runs}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">Error loading data</td></tr>';
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadParameters();
            await loadLeaderboard();
        });
    </script>
</body>
</html>